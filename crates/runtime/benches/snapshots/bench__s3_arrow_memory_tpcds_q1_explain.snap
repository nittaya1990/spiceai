---
source: crates/runtime/benches/bench.rs
description: "Query: with customer_total_return as\n(select sr_customer_sk as ctr_customer_sk\n,sr_store_sk as ctr_store_sk\n,sum(SR_RETURN_AMT_INC_TAX) as ctr_total_return\nfrom store_returns\n,date_dim\nwhere sr_returned_date_sk = d_date_sk\nand d_year =1999\ngroup by sr_customer_sk\n,sr_store_sk)\n select  c_customer_id\nfrom customer_total_return ctr1\n,store\n,customer\nwhere ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2\nfrom customer_total_return ctr2\nwhere ctr1.ctr_store_sk = ctr2.ctr_store_sk)\nand s_store_sk = ctr1.ctr_store_sk\nand s_state = 'TN'\nand ctr1.ctr_customer_sk = c_customer_sk\norder by c_customer_id\n LIMIT 100;\n"
snapshot_kind: text
---
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| plan_type     | plan                                                                                                                                                                                                                            |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| logical_plan  | Sort: customer.c_customer_id ASC NULLS LAST, fetch=100                                                                                                                                                                          |
|               |   Projection: customer.c_customer_id                                                                                                                                                                                            |
|               |     Inner Join: ctr1.ctr_store_sk = __scalar_sq_1.ctr_store_sk Filter: CAST(ctr1.ctr_total_return AS Decimal128(30, 15)) > __scalar_sq_1.avg(ctr2.ctr_total_return) * Float64(1.2)                                              |
|               |       Projection: ctr1.ctr_store_sk, ctr1.ctr_total_return, customer.c_customer_id                                                                                                                                              |
|               |         Inner Join: ctr1.ctr_customer_sk = customer.c_customer_sk                                                                                                                                                               |
|               |           Projection: ctr1.ctr_customer_sk, ctr1.ctr_store_sk, ctr1.ctr_total_return                                                                                                                                            |
|               |             Inner Join: ctr1.ctr_store_sk = store.s_store_sk                                                                                                                                                                    |
|               |               SubqueryAlias: ctr1                                                                                                                                                                                               |
|               |                 SubqueryAlias: customer_total_return                                                                                                                                                                            |
|               |                   Projection: store_returns.sr_customer_sk AS ctr_customer_sk, store_returns.sr_store_sk AS ctr_store_sk, sum(store_returns.sr_return_amt_inc_tax) AS ctr_total_return                                          |
|               |                     Aggregate: groupBy=[[store_returns.sr_customer_sk, store_returns.sr_store_sk]], aggr=[[sum(store_returns.sr_return_amt_inc_tax)]]                                                                           |
|               |                       Projection: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_return_amt_inc_tax                                                                                                  |
|               |                         Inner Join: store_returns.sr_returned_date_sk = date_dim.d_date_sk                                                                                                                                      |
|               |                           BytesProcessedNode                                                                                                                                                                                    |
|               |                             TableScan: store_returns projection=[sr_returned_date_sk, sr_customer_sk, sr_store_sk, sr_return_amt_inc_tax]                                                                                       |
|               |                           Projection: date_dim.d_date_sk                                                                                                                                                                        |
|               |                             BytesProcessedNode                                                                                                                                                                                  |
|               |                               Filter: date_dim.d_year = Int32(1999)                                                                                                                                                             |
|               |                                 TableScan: date_dim projection=[d_date_sk, d_year]                                                                                                                                              |
|               |               Projection: store.s_store_sk                                                                                                                                                                                      |
|               |                 BytesProcessedNode                                                                                                                                                                                              |
|               |                   Filter: store.s_state = Utf8View("TN")                                                                                                                                                                        |
|               |                     TableScan: store projection=[s_store_sk, s_state]                                                                                                                                                           |
|               |           BytesProcessedNode                                                                                                                                                                                                    |
|               |             TableScan: customer projection=[c_customer_sk, c_customer_id]                                                                                                                                                       |
|               |       SubqueryAlias: __scalar_sq_1                                                                                                                                                                                              |
|               |         Projection: CAST(CAST(avg(ctr2.ctr_total_return) AS Float64) * Float64(1.2) AS Decimal128(30, 15)), ctr2.ctr_store_sk                                                                                                   |
|               |           Aggregate: groupBy=[[ctr2.ctr_store_sk]], aggr=[[avg(ctr2.ctr_total_return)]]                                                                                                                                         |
|               |             SubqueryAlias: ctr2                                                                                                                                                                                                 |
|               |               SubqueryAlias: customer_total_return                                                                                                                                                                              |
|               |                 Projection: store_returns.sr_store_sk AS ctr_store_sk, sum(store_returns.sr_return_amt_inc_tax) AS ctr_total_return                                                                                             |
|               |                   Aggregate: groupBy=[[store_returns.sr_customer_sk, store_returns.sr_store_sk]], aggr=[[sum(store_returns.sr_return_amt_inc_tax)]]                                                                             |
|               |                     Projection: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_return_amt_inc_tax                                                                                                    |
|               |                       Inner Join: store_returns.sr_returned_date_sk = date_dim.d_date_sk                                                                                                                                        |
|               |                         BytesProcessedNode                                                                                                                                                                                      |
|               |                           TableScan: store_returns projection=[sr_returned_date_sk, sr_customer_sk, sr_store_sk, sr_return_amt_inc_tax]                                                                                         |
|               |                         Projection: date_dim.d_date_sk                                                                                                                                                                          |
|               |                           BytesProcessedNode                                                                                                                                                                                    |
|               |                             Filter: date_dim.d_year = Int32(1999)                                                                                                                                                               |
|               |                               TableScan: date_dim projection=[d_date_sk, d_year]                                                                                                                                                |
| physical_plan | SortPreservingMergeExec: [c_customer_id@0 ASC NULLS LAST], fetch=100                                                                                                                                                            |
|               |   SortExec: TopK(fetch=100), expr=[c_customer_id@0 ASC NULLS LAST], preserve_partitioning=[true]                                                                                                                                |
|               |     CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                 |
|               |       HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ctr_store_sk@0, ctr_store_sk@1)], filter=CAST(ctr_total_return@0 AS Decimal128(30, 15)) > avg(ctr2.ctr_total_return) * Float64(1.2)@1, projection=[c_customer_id@2] |
|               |         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                             |
|               |           RepartitionExec: partitioning=Hash([ctr_store_sk@0], 4), input_partitions=4                                                                                                                                           |
|               |             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                         |
|               |               HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ctr_customer_sk@0, c_customer_sk@0)], projection=[ctr_store_sk@1, ctr_total_return@2, c_customer_id@4]                                                      |
|               |                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                     |
|               |                   RepartitionExec: partitioning=Hash([ctr_customer_sk@0], 4), input_partitions=4                                                                                                                                |
|               |                     CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                 |
|               |                       HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ctr_store_sk@1, s_store_sk@0)], projection=[ctr_customer_sk@0, ctr_store_sk@1, ctr_total_return@2]                                                  |
|               |                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                             |
|               |                           RepartitionExec: partitioning=Hash([ctr_store_sk@1], 4), input_partitions=4                                                                                                                           |
|               |                             ProjectionExec: expr=[sr_customer_sk@0 as ctr_customer_sk, sr_store_sk@1 as ctr_store_sk, sum(store_returns.sr_return_amt_inc_tax)@2 as ctr_total_return]                                           |
|               |                               AggregateExec: mode=FinalPartitioned, gby=[sr_customer_sk@0 as sr_customer_sk, sr_store_sk@1 as sr_store_sk], aggr=[sum(store_returns.sr_return_amt_inc_tax)]                                     |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                     |
|               |                                   RepartitionExec: partitioning=Hash([sr_customer_sk@0, sr_store_sk@1], 4), input_partitions=4                                                                                                  |
|               |                                     AggregateExec: mode=Partial, gby=[sr_customer_sk@0 as sr_customer_sk, sr_store_sk@1 as sr_store_sk], aggr=[sum(store_returns.sr_return_amt_inc_tax)]                                        |
|               |                                       CoalesceBatchesExec: target_batch_size=8192                                                                                                                                               |
|               |                                         HashJoinExec: mode=Partitioned, join_type=Inner, on=[(sr_returned_date_sk@0, d_date_sk@0)], projection=[sr_customer_sk@1, sr_store_sk@2, sr_return_amt_inc_tax@3]                       |
|               |                                           CoalesceBatchesExec: target_batch_size=8192                                                                                                                                           |
|               |                                             RepartitionExec: partitioning=Hash([sr_returned_date_sk@0], 4), input_partitions=4                                                                                                  |
|               |                                               BytesProcessedExec                                                                                                                                                                |
|               |                                                 SchemaCastScanExec                                                                                                                                                              |
|               |                                                   RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                          |
|               |                                                     MemoryExec: partitions=1, partition_sizes=[36]                                                                                                                              |
|               |                                           CoalesceBatchesExec: target_batch_size=8192                                                                                                                                           |
|               |                                             RepartitionExec: partitioning=Hash([d_date_sk@0], 4), input_partitions=4                                                                                                            |
|               |                                               ProjectionExec: expr=[d_date_sk@0 as d_date_sk]                                                                                                                                   |
|               |                                                 BytesProcessedExec                                                                                                                                                              |
|               |                                                   CoalesceBatchesExec: target_batch_size=8192                                                                                                                                   |
|               |                                                     FilterExec: d_year@1 = 1999                                                                                                                                                 |
|               |                                                       SchemaCastScanExec                                                                                                                                                        |
|               |                                                         RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                    |
|               |                                                           MemoryExec: partitions=1, partition_sizes=[9]                                                                                                                         |
|               |                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                             |
|               |                           RepartitionExec: partitioning=Hash([s_store_sk@0], 4), input_partitions=4                                                                                                                             |
|               |                             ProjectionExec: expr=[s_store_sk@0 as s_store_sk]                                                                                                                                                   |
|               |                               BytesProcessedExec                                                                                                                                                                                |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                     |
|               |                                   FilterExec: s_state@1 = TN                                                                                                                                                                    |
|               |                                     RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                        |
|               |                                       SchemaCastScanExec                                                                                                                                                                        |
|               |                                         MemoryExec: partitions=1, partition_sizes=[1]                                                                                                                                           |
|               |                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                     |
|               |                   RepartitionExec: partitioning=Hash([c_customer_sk@0], 4), input_partitions=4                                                                                                                                  |
|               |                     BytesProcessedExec                                                                                                                                                                                          |
|               |                       SchemaCastScanExec                                                                                                                                                                                        |
|               |                         RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                                    |
|               |                           MemoryExec: partitions=1, partition_sizes=[13]                                                                                                                                                        |
|               |         ProjectionExec: expr=[CAST(CAST(avg(ctr2.ctr_total_return)@1 AS Float64) * 1.2 AS Decimal128(30, 15)) as avg(ctr2.ctr_total_return) * Float64(1.2), ctr_store_sk@0 as ctr_store_sk]                                     |
|               |           AggregateExec: mode=FinalPartitioned, gby=[ctr_store_sk@0 as ctr_store_sk], aggr=[avg(ctr2.ctr_total_return)]                                                                                                         |
|               |             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                         |
|               |               RepartitionExec: partitioning=Hash([ctr_store_sk@0], 4), input_partitions=4                                                                                                                                       |
|               |                 AggregateExec: mode=Partial, gby=[ctr_store_sk@0 as ctr_store_sk], aggr=[avg(ctr2.ctr_total_return)]                                                                                                            |
|               |                   ProjectionExec: expr=[sr_store_sk@1 as ctr_store_sk, sum(store_returns.sr_return_amt_inc_tax)@2 as ctr_total_return]                                                                                          |
|               |                     AggregateExec: mode=FinalPartitioned, gby=[sr_customer_sk@0 as sr_customer_sk, sr_store_sk@1 as sr_store_sk], aggr=[sum(store_returns.sr_return_amt_inc_tax)]                                               |
|               |                       CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                               |
|               |                         RepartitionExec: partitioning=Hash([sr_customer_sk@0, sr_store_sk@1], 4), input_partitions=4                                                                                                            |
|               |                           AggregateExec: mode=Partial, gby=[sr_customer_sk@0 as sr_customer_sk, sr_store_sk@1 as sr_store_sk], aggr=[sum(store_returns.sr_return_amt_inc_tax)]                                                  |
|               |                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                         |
|               |                               HashJoinExec: mode=Partitioned, join_type=Inner, on=[(sr_returned_date_sk@0, d_date_sk@0)], projection=[sr_customer_sk@1, sr_store_sk@2, sr_return_amt_inc_tax@3]                                 |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                     |
|               |                                   RepartitionExec: partitioning=Hash([sr_returned_date_sk@0], 4), input_partitions=4                                                                                                            |
|               |                                     BytesProcessedExec                                                                                                                                                                          |
|               |                                       SchemaCastScanExec                                                                                                                                                                        |
|               |                                         RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                    |
|               |                                           MemoryExec: partitions=1, partition_sizes=[36]                                                                                                                                        |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                     |
|               |                                   RepartitionExec: partitioning=Hash([d_date_sk@0], 4), input_partitions=4                                                                                                                      |
|               |                                     ProjectionExec: expr=[d_date_sk@0 as d_date_sk]                                                                                                                                             |
|               |                                       BytesProcessedExec                                                                                                                                                                        |
|               |                                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                             |
|               |                                           FilterExec: d_year@1 = 1999                                                                                                                                                           |
|               |                                             SchemaCastScanExec                                                                                                                                                                  |
|               |                                               RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                              |
|               |                                                 MemoryExec: partitions=1, partition_sizes=[9]                                                                                                                                   |
|               |                                                                                                                                                                                                                                 |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
