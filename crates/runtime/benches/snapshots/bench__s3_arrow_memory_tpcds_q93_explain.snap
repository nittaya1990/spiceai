---
source: crates/runtime/benches/bench.rs
description: "Query: select  ss_customer_sk\n            ,sum(act_sales) sumsales\n      from (select ss_item_sk\n                  ,ss_ticket_number\n                  ,ss_customer_sk\n                  ,case when sr_return_quantity is not null then (ss_quantity-sr_return_quantity)*ss_sales_price\n                                                            else (ss_quantity*ss_sales_price) end act_sales\n            from store_sales left outer join store_returns on (sr_item_sk = ss_item_sk\n                                                               and sr_ticket_number = ss_ticket_number)\n                ,reason\n            where sr_reason_sk = r_reason_sk\n              and r_reason_desc = 'Did not get it on time') t\n      group by ss_customer_sk\n      order by sumsales, ss_customer_sk\n LIMIT 100;\n"
snapshot_kind: text
---
+---------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| plan_type     | plan                                                                                                                                                                                                                                                                                                                                 |
+---------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| logical_plan  | Sort: sumsales ASC NULLS LAST, t.ss_customer_sk ASC NULLS LAST, fetch=100                                                                                                                                                                                                                                                            |
|               |   Projection: t.ss_customer_sk, sum(t.act_sales) AS sumsales                                                                                                                                                                                                                                                                         |
|               |     Aggregate: groupBy=[[t.ss_customer_sk]], aggr=[[sum(t.act_sales)]]                                                                                                                                                                                                                                                               |
|               |       SubqueryAlias: t                                                                                                                                                                                                                                                                                                               |
|               |         Projection: store_sales.ss_customer_sk, CASE WHEN store_returns.sr_return_quantity IS NOT NULL THEN CAST(store_sales.ss_quantity - store_returns.sr_return_quantity AS Decimal128(10, 0)) * store_sales.ss_sales_price ELSE CAST(store_sales.ss_quantity AS Decimal128(10, 0)) * store_sales.ss_sales_price END AS act_sales |
|               |           Inner Join: store_returns.sr_reason_sk = reason.r_reason_sk                                                                                                                                                                                                                                                                |
|               |             Projection: store_sales.ss_customer_sk, store_sales.ss_quantity, store_sales.ss_sales_price, store_returns.sr_reason_sk, store_returns.sr_return_quantity                                                                                                                                                                |
|               |               Left Join: store_sales.ss_item_sk = store_returns.sr_item_sk, store_sales.ss_ticket_number = store_returns.sr_ticket_number                                                                                                                                                                                            |
|               |                 BytesProcessedNode                                                                                                                                                                                                                                                                                                   |
|               |                   TableScan: store_sales projection=[ss_item_sk, ss_customer_sk, ss_ticket_number, ss_quantity, ss_sales_price]                                                                                                                                                                                                      |
|               |                 BytesProcessedNode                                                                                                                                                                                                                                                                                                   |
|               |                   TableScan: store_returns projection=[sr_item_sk, sr_reason_sk, sr_ticket_number, sr_return_quantity]                                                                                                                                                                                                               |
|               |             Projection: reason.r_reason_sk                                                                                                                                                                                                                                                                                           |
|               |               BytesProcessedNode                                                                                                                                                                                                                                                                                                     |
|               |                 Filter: reason.r_reason_desc = LargeUtf8("Did not get it on time")                                                                                                                                                                                                                                                   |
|               |                   TableScan: reason projection=[r_reason_sk, r_reason_desc]                                                                                                                                                                                                                                                          |
| physical_plan | SortPreservingMergeExec: [sumsales@1 ASC NULLS LAST, ss_customer_sk@0 ASC NULLS LAST], fetch=100                                                                                                                                                                                                                                     |
|               |   SortExec: TopK(fetch=100), expr=[sumsales@1 ASC NULLS LAST, ss_customer_sk@0 ASC NULLS LAST], preserve_partitioning=[true]                                                                                                                                                                                                         |
|               |     ProjectionExec: expr=[ss_customer_sk@0 as ss_customer_sk, sum(t.act_sales)@1 as sumsales]                                                                                                                                                                                                                                        |
|               |       AggregateExec: mode=FinalPartitioned, gby=[ss_customer_sk@0 as ss_customer_sk], aggr=[sum(t.act_sales)]                                                                                                                                                                                                                        |
|               |         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                                                  |
|               |           RepartitionExec: partitioning=Hash([ss_customer_sk@0], 4), input_partitions=4                                                                                                                                                                                                                                              |
|               |             AggregateExec: mode=Partial, gby=[ss_customer_sk@0 as ss_customer_sk], aggr=[sum(t.act_sales)]                                                                                                                                                                                                                           |
|               |               ProjectionExec: expr=[ss_customer_sk@0 as ss_customer_sk, CASE WHEN sr_return_quantity@3 IS NOT NULL THEN CAST(ss_quantity@1 - sr_return_quantity@3 AS Decimal128(10, 0)) * ss_sales_price@2 ELSE CAST(ss_quantity@1 AS Decimal128(10, 0)) * ss_sales_price@2 END as act_sales]                                        |
|               |                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                                          |
|               |                   HashJoinExec: mode=Partitioned, join_type=Inner, on=[(sr_reason_sk@3, r_reason_sk@0)], projection=[ss_customer_sk@0, ss_quantity@1, ss_sales_price@2, sr_return_quantity@4]                                                                                                                                        |
|               |                     CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                                      |
|               |                       RepartitionExec: partitioning=Hash([sr_reason_sk@3], 4), input_partitions=4                                                                                                                                                                                                                                    |
|               |                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                                  |
|               |                           HashJoinExec: mode=Partitioned, join_type=Left, on=[(ss_item_sk@0, sr_item_sk@0), (ss_ticket_number@2, sr_ticket_number@2)], projection=[ss_customer_sk@1, ss_quantity@3, ss_sales_price@4, sr_reason_sk@6, sr_return_quantity@8]                                                                          |
|               |                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                              |
|               |                               RepartitionExec: partitioning=Hash([ss_item_sk@0, ss_ticket_number@2], 4), input_partitions=4                                                                                                                                                                                                          |
|               |                                 BytesProcessedExec                                                                                                                                                                                                                                                                                   |
|               |                                   SchemaCastScanExec                                                                                                                                                                                                                                                                                 |
|               |                                     RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                                                                                                                             |
|               |                                       MemoryExec: partitions=1, partition_sizes=[352]                                                                                                                                                                                                                                                |
|               |                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                              |
|               |                               RepartitionExec: partitioning=Hash([sr_item_sk@0, sr_ticket_number@2], 4), input_partitions=4                                                                                                                                                                                                          |
|               |                                 BytesProcessedExec                                                                                                                                                                                                                                                                                   |
|               |                                   SchemaCastScanExec                                                                                                                                                                                                                                                                                 |
|               |                                     RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                                                                                                                             |
|               |                                       MemoryExec: partitions=1, partition_sizes=[36]                                                                                                                                                                                                                                                 |
|               |                     CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                                      |
|               |                       RepartitionExec: partitioning=Hash([r_reason_sk@0], 4), input_partitions=4                                                                                                                                                                                                                                     |
|               |                         ProjectionExec: expr=[r_reason_sk@0 as r_reason_sk]                                                                                                                                                                                                                                                          |
|               |                           BytesProcessedExec                                                                                                                                                                                                                                                                                         |
|               |                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                                                                                                                              |
|               |                               FilterExec: r_reason_desc@1 = Did not get it on time                                                                                                                                                                                                                                                   |
|               |                                 RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                                                                                                                                                 |
|               |                                   SchemaCastScanExec                                                                                                                                                                                                                                                                                 |
|               |                                     MemoryExec: partitions=1, partition_sizes=[1]                                                                                                                                                                                                                                                    |
|               |                                                                                                                                                                                                                                                                                                                                      |
+---------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
