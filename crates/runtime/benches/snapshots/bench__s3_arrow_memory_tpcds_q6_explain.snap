---
source: crates/runtime/benches/bench.rs
description: "Query: select  a.ca_state state, count(*) cnt\n from customer_address a\n     ,customer c\n     ,store_sales s\n     ,date_dim d\n     ,item i\n where       a.ca_address_sk = c.c_current_addr_sk\n \tand c.c_customer_sk = s.ss_customer_sk\n \tand s.ss_sold_date_sk = d.d_date_sk\n \tand s.ss_item_sk = i.i_item_sk\n \tand d.d_month_seq =\n \t     (select distinct (d_month_seq)\n \t      from date_dim\n               where d_year = 1998\n \t        and d_moy = 3 )\n \tand i.i_current_price > 1.2 *\n             (select avg(j.i_current_price)\n \t     from item j\n \t     where j.i_category = i.i_category)\n group by a.ca_state\n having count(*) >= 10\n order by cnt, a.ca_state\n  LIMIT 100;\n"
snapshot_kind: text
---
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| plan_type     | plan                                                                                                                                                                                                          |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| logical_plan  | Projection: state, cnt                                                                                                                                                                                        |
|               |   Sort: cnt ASC NULLS LAST, a.ca_state ASC NULLS LAST, fetch=100                                                                                                                                              |
|               |     Projection: a.ca_state AS state, count(*) AS cnt, a.ca_state                                                                                                                                              |
|               |       Filter: count(*) >= Int64(10)                                                                                                                                                                           |
|               |         Aggregate: groupBy=[[a.ca_state]], aggr=[[count(Int64(1)) AS count(*)]]                                                                                                                               |
|               |           Projection: a.ca_state                                                                                                                                                                              |
|               |             Filter: CAST(i.i_current_price AS Decimal128(30, 15)) > CAST(Float64(1.2) * __scalar_sq_2.avg(j.i_current_price) AS Decimal128(30, 15))                                                           |
|               |               Projection: a.ca_state, i.i_current_price, __scalar_sq_2.avg(j.i_current_price)                                                                                                                 |
|               |                 Left Join: i.i_category = __scalar_sq_2.i_category                                                                                                                                            |
|               |                   Projection: a.ca_state, i.i_current_price, i.i_category                                                                                                                                     |
|               |                     Inner Join: d.d_month_seq = __scalar_sq_1.d_month_seq                                                                                                                                     |
|               |                       Projection: a.ca_state, d.d_month_seq, i.i_current_price, i.i_category                                                                                                                  |
|               |                         Inner Join: s.ss_item_sk = i.i_item_sk                                                                                                                                                |
|               |                           Projection: a.ca_state, s.ss_item_sk, d.d_month_seq                                                                                                                                 |
|               |                             Inner Join: s.ss_sold_date_sk = d.d_date_sk                                                                                                                                       |
|               |                               Projection: a.ca_state, s.ss_sold_date_sk, s.ss_item_sk                                                                                                                         |
|               |                                 Inner Join: c.c_customer_sk = s.ss_customer_sk                                                                                                                                |
|               |                                   Projection: a.ca_state, c.c_customer_sk                                                                                                                                     |
|               |                                     Inner Join: a.ca_address_sk = c.c_current_addr_sk                                                                                                                         |
|               |                                       SubqueryAlias: a                                                                                                                                                        |
|               |                                         BytesProcessedNode                                                                                                                                                    |
|               |                                           TableScan: customer_address projection=[ca_address_sk, ca_state]                                                                                                    |
|               |                                       SubqueryAlias: c                                                                                                                                                        |
|               |                                         BytesProcessedNode                                                                                                                                                    |
|               |                                           TableScan: customer projection=[c_customer_sk, c_current_addr_sk]                                                                                                   |
|               |                                   SubqueryAlias: s                                                                                                                                                            |
|               |                                     BytesProcessedNode                                                                                                                                                        |
|               |                                       TableScan: store_sales projection=[ss_sold_date_sk, ss_item_sk, ss_customer_sk]                                                                                         |
|               |                               SubqueryAlias: d                                                                                                                                                                |
|               |                                 BytesProcessedNode                                                                                                                                                            |
|               |                                   TableScan: date_dim projection=[d_date_sk, d_month_seq]                                                                                                                     |
|               |                           SubqueryAlias: i                                                                                                                                                                    |
|               |                             BytesProcessedNode                                                                                                                                                                |
|               |                               TableScan: item projection=[i_item_sk, i_current_price, i_category]                                                                                                             |
|               |                       SubqueryAlias: __scalar_sq_1                                                                                                                                                            |
|               |                         Aggregate: groupBy=[[date_dim.d_month_seq]], aggr=[[]]                                                                                                                                |
|               |                           Projection: date_dim.d_month_seq                                                                                                                                                    |
|               |                             BytesProcessedNode                                                                                                                                                                |
|               |                               Filter: date_dim.d_year = Int32(1998) AND date_dim.d_moy = Int32(3)                                                                                                             |
|               |                                 TableScan: date_dim projection=[d_month_seq, d_year, d_moy]                                                                                                                   |
|               |                   SubqueryAlias: __scalar_sq_2                                                                                                                                                                |
|               |                     Projection: CAST(avg(j.i_current_price) AS Float64), j.i_category                                                                                                                         |
|               |                       Aggregate: groupBy=[[j.i_category]], aggr=[[avg(j.i_current_price)]]                                                                                                                    |
|               |                         SubqueryAlias: j                                                                                                                                                                      |
|               |                           BytesProcessedNode                                                                                                                                                                  |
|               |                             TableScan: item projection=[i_current_price, i_category]                                                                                                                          |
| physical_plan | ProjectionExec: expr=[state@0 as state, cnt@1 as cnt]                                                                                                                                                         |
|               |   SortPreservingMergeExec: [cnt@1 ASC NULLS LAST, ca_state@2 ASC NULLS LAST], fetch=100                                                                                                                       |
|               |     SortExec: TopK(fetch=100), expr=[cnt@1 ASC NULLS LAST, ca_state@2 ASC NULLS LAST], preserve_partitioning=[true]                                                                                           |
|               |       ProjectionExec: expr=[ca_state@0 as state, count(*)@1 as cnt, ca_state@0 as ca_state]                                                                                                                   |
|               |         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                           |
|               |           FilterExec: count(*)@1 >= 10                                                                                                                                                                        |
|               |             AggregateExec: mode=FinalPartitioned, gby=[ca_state@0 as ca_state], aggr=[count(*)]                                                                                                               |
|               |               CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                     |
|               |                 RepartitionExec: partitioning=Hash([ca_state@0], 4), input_partitions=4                                                                                                                       |
|               |                   AggregateExec: mode=Partial, gby=[ca_state@0 as ca_state], aggr=[count(*)]                                                                                                                  |
|               |                     CoalesceBatchesExec: target_batch_size=8192                                                                                                                                               |
|               |                       FilterExec: CAST(i_current_price@1 AS Decimal128(30, 15)) > CAST(1.2 * avg(j.i_current_price)@2 AS Decimal128(30, 15)), projection=[ca_state@0]                                         |
|               |                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                                           |
|               |                           HashJoinExec: mode=Partitioned, join_type=Left, on=[(i_category@2, i_category@1)], projection=[ca_state@0, i_current_price@1, avg(j.i_current_price)@3]                             |
|               |                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                                       |
|               |                               RepartitionExec: partitioning=Hash([i_category@2], 4), input_partitions=4                                                                                                       |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                   |
|               |                                   HashJoinExec: mode=Partitioned, join_type=Inner, on=[(d_month_seq@1, d_month_seq@0)], projection=[ca_state@0, i_current_price@2, i_category@3]                              |
|               |                                     CoalesceBatchesExec: target_batch_size=8192                                                                                                                               |
|               |                                       RepartitionExec: partitioning=Hash([d_month_seq@1], 4), input_partitions=4                                                                                              |
|               |                                         CoalesceBatchesExec: target_batch_size=8192                                                                                                                           |
|               |                                           HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ss_item_sk@1, i_item_sk@0)], projection=[ca_state@0, d_month_seq@2, i_current_price@4, i_category@5]          |
|               |                                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                       |
|               |                                               RepartitionExec: partitioning=Hash([ss_item_sk@1], 4), input_partitions=4                                                                                       |
|               |                                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                   |
|               |                                                   HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ss_sold_date_sk@1, d_date_sk@0)], projection=[ca_state@0, ss_item_sk@2, d_month_seq@4]                |
|               |                                                     CoalesceBatchesExec: target_batch_size=8192                                                                                                               |
|               |                                                       RepartitionExec: partitioning=Hash([ss_sold_date_sk@1], 4), input_partitions=4                                                                          |
|               |                                                         CoalesceBatchesExec: target_batch_size=8192                                                                                                           |
|               |                                                           HashJoinExec: mode=Partitioned, join_type=Inner, on=[(c_customer_sk@1, ss_customer_sk@2)], projection=[ca_state@0, ss_sold_date_sk@2, ss_item_sk@3] |
|               |                                                             CoalesceBatchesExec: target_batch_size=8192                                                                                                       |
|               |                                                               RepartitionExec: partitioning=Hash([c_customer_sk@1], 4), input_partitions=4                                                                    |
|               |                                                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                   |
|               |                                                                   HashJoinExec: mode=Partitioned, join_type=Inner, on=[(ca_address_sk@0, c_current_addr_sk@1)], projection=[ca_state@1, c_customer_sk@2]      |
|               |                                                                     CoalesceBatchesExec: target_batch_size=8192                                                                                               |
|               |                                                                       RepartitionExec: partitioning=Hash([ca_address_sk@0], 4), input_partitions=4                                                            |
|               |                                                                         BytesProcessedExec                                                                                                                    |
|               |                                                                           SchemaCastScanExec                                                                                                                  |
|               |                                                                             RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                              |
|               |                                                                               MemoryExec: partitions=1, partition_sizes=[7]                                                                                   |
|               |                                                                     CoalesceBatchesExec: target_batch_size=8192                                                                                               |
|               |                                                                       RepartitionExec: partitioning=Hash([c_current_addr_sk@1], 4), input_partitions=4                                                        |
|               |                                                                         BytesProcessedExec                                                                                                                    |
|               |                                                                           SchemaCastScanExec                                                                                                                  |
|               |                                                                             RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                              |
|               |                                                                               MemoryExec: partitions=1, partition_sizes=[13]                                                                                  |
|               |                                                             CoalesceBatchesExec: target_batch_size=8192                                                                                                       |
|               |                                                               RepartitionExec: partitioning=Hash([ss_customer_sk@2], 4), input_partitions=4                                                                   |
|               |                                                                 BytesProcessedExec                                                                                                                            |
|               |                                                                   SchemaCastScanExec                                                                                                                          |
|               |                                                                     RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                      |
|               |                                                                       MemoryExec: partitions=1, partition_sizes=[352]                                                                                         |
|               |                                                     CoalesceBatchesExec: target_batch_size=8192                                                                                                               |
|               |                                                       RepartitionExec: partitioning=Hash([d_date_sk@0], 4), input_partitions=4                                                                                |
|               |                                                         BytesProcessedExec                                                                                                                                    |
|               |                                                           SchemaCastScanExec                                                                                                                                  |
|               |                                                             RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                              |
|               |                                                               MemoryExec: partitions=1, partition_sizes=[9]                                                                                                   |
|               |                                             CoalesceBatchesExec: target_batch_size=8192                                                                                                                       |
|               |                                               RepartitionExec: partitioning=Hash([i_item_sk@0], 4), input_partitions=4                                                                                        |
|               |                                                 BytesProcessedExec                                                                                                                                            |
|               |                                                   SchemaCastScanExec                                                                                                                                          |
|               |                                                     RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                      |
|               |                                                       MemoryExec: partitions=1, partition_sizes=[3]                                                                                                           |
|               |                                     AggregateExec: mode=FinalPartitioned, gby=[d_month_seq@0 as d_month_seq], aggr=[]                                                                                         |
|               |                                       CoalesceBatchesExec: target_batch_size=8192                                                                                                                             |
|               |                                         RepartitionExec: partitioning=Hash([d_month_seq@0], 4), input_partitions=4                                                                                            |
|               |                                           AggregateExec: mode=Partial, gby=[d_month_seq@0 as d_month_seq], aggr=[]                                                                                            |
|               |                                             ProjectionExec: expr=[d_month_seq@0 as d_month_seq]                                                                                                               |
|               |                                               BytesProcessedExec                                                                                                                                              |
|               |                                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                   |
|               |                                                   FilterExec: d_year@1 = 1998 AND d_moy@2 = 3                                                                                                                 |
|               |                                                     SchemaCastScanExec                                                                                                                                        |
|               |                                                       RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                    |
|               |                                                         MemoryExec: partitions=1, partition_sizes=[9]                                                                                                         |
|               |                             ProjectionExec: expr=[CAST(avg(j.i_current_price)@1 AS Float64) as avg(j.i_current_price), i_category@0 as i_category]                                                            |
|               |                               AggregateExec: mode=FinalPartitioned, gby=[i_category@0 as i_category], aggr=[avg(j.i_current_price)]                                                                           |
|               |                                 CoalesceBatchesExec: target_batch_size=8192                                                                                                                                   |
|               |                                   RepartitionExec: partitioning=Hash([i_category@0], 4), input_partitions=4                                                                                                   |
|               |                                     AggregateExec: mode=Partial, gby=[i_category@1 as i_category], aggr=[avg(j.i_current_price)]                                                                              |
|               |                                       BytesProcessedExec                                                                                                                                                      |
|               |                                         SchemaCastScanExec                                                                                                                                                    |
|               |                                           RepartitionExec: partitioning=RoundRobinBatch(4), input_partitions=1                                                                                                |
|               |                                             MemoryExec: partitions=1, partition_sizes=[3]                                                                                                                     |
|               |                                                                                                                                                                                                               |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
